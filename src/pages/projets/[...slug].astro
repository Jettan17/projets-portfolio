---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Button from '../../components/Button.astro';
import SkillBadge from '../../components/SkillBadge.astro';
import GeneratedImage from '../../components/GeneratedImage.astro';
import { getCollection } from 'astro:content';
import { getGitHubProjects } from '../../utils/projects';
import { getLogoUrl } from '../../utils/logos';

export async function getStaticPaths() {
  // Get markdown projets
  const markdownProjets = await getCollection('projets');
  const markdownPaths = markdownProjets.map(projet => ({
    params: { slug: projet.slug },
    props: { project: projet, projectType: 'markdown' as const },
  }));

  // Get GitHub projects
  const githubProjectsList = await getGitHubProjects();
  const githubPaths = githubProjectsList.map(project => ({
    params: { slug: project.slug },
    props: { project, projectType: 'github' as const },
  }));

  return [...markdownPaths, ...githubPaths];
}

const { project, projectType } = Astro.props;
const { title, description, image, tags, liveUrl, repoUrl, publishDate, stars, language } = project.data;

// Only render content for markdown projects
let Content = null;
if (projectType === 'markdown' && 'render' in project) {
  const rendered = await project.render();
  Content = rendered.Content;
}

const isGitHub = projectType === 'github';
const repoName = isGitHub ? project.slug.replace('github-', '') : '';
const logoUrl = isGitHub ? getLogoUrl(repoName) : null;

const formattedDate = new Intl.DateTimeFormat('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
}).format(publishDate);
---

<BaseLayout title={title} description={description}>
  <article class="project-detail">
    <div class="container">
      <!-- Header -->
      <header class="project-header">
        <a href="/projets" class="back-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
          </svg>
          Back to Projets
        </a>

        <h1 class="project-title">{title}</h1>
        <p class="project-description">{description}</p>

        <div class="project-meta">
          <time datetime={publishDate.toISOString()} class="project-date">
            {formattedDate}
          </time>
          <div class="project-tags">
            {tags.map(tag => (
              <SkillBadge skill={tag} variant="primary" />
            ))}
          </div>
        </div>

        <div class="project-actions">
          {liveUrl && (
            <Button href={liveUrl} variant="primary" external>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                <polyline points="15 3 21 3 21 9"></polyline>
                <line x1="10" y1="14" x2="21" y2="3"></line>
              </svg>
              View Live Demo
            </Button>
          )}
          {repoUrl && (
            <Button href={repoUrl} variant="outline" external>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
              </svg>
              View Source
            </Button>
          )}
        </div>
      </header>

      <!-- Image -->
      <div class="project-image-container">
        <div class="project-image">
          {isGitHub ? (
            <GeneratedImage title={title} language={language} repoName={repoName} logoUrl={logoUrl} />
          ) : (
            <div class="project-image-placeholder">
              <span class="project-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="64" height="64">
                  <path d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                </svg>
              </span>
            </div>
          )}
        </div>
      </div>

      <!-- Content -->
      {Content ? (
        <div class="project-content prose">
          <Content />
        </div>
      ) : (
        <div class="project-content github-content">
          <div class="github-info">
            {stars !== undefined && stars > 0 && (
              <div class="github-stat">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
                <span>{stars} stars</span>
              </div>
            )}
            {language && (
              <div class="github-stat">
                <span class="language-dot" style={`background-color: var(--lang-${language.toLowerCase()}, #6e7681)`}></span>
                <span>{language}</span>
              </div>
            )}
          </div>
          <p class="github-description">
            This project is maintained on GitHub. Click the link below to view the full README,
            source code, and contribution guidelines.
          </p>
          <Button href={repoUrl} variant="primary" external>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
              <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
            View on GitHub
          </Button>
        </div>
      )}

      <!-- Footer -->
      <footer class="project-footer">
        <Button href="/projets" variant="ghost">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
          </svg>
          Back to All Projets
        </Button>
      </footer>
    </div>
  </article>
</BaseLayout>

<style>
  .project-detail {
    padding-top: var(--space-8);
    padding-bottom: var(--space-16);
  }

  .project-header {
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
    margin-bottom: var(--space-8);
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--text-secondary);
    text-decoration: none;
    margin-bottom: var(--space-6);
    transition: color var(--transition-fast);
  }

  .back-link:hover {
    color: var(--color-primary);
  }

  .project-title {
    font-size: clamp(2.5rem, 6vw, 4rem);
    margin-bottom: var(--space-4);
  }

  .project-description {
    font-size: var(--text-2xl);
    color: var(--text-secondary);
    line-height: var(--leading-relaxed);
    margin-bottom: var(--space-6);
  }

  .project-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }

  .project-date {
    font-size: var(--text-sm);
    color: var(--text-tertiary);
  }

  .project-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .project-actions {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-4);
  }

  .project-actions :global(.button) {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
  }

  .project-image-container {
    max-width: 1000px;
    margin-left: auto;
    margin-right: auto;
    margin-bottom: var(--space-12);
  }

  .project-image {
    aspect-ratio: 16 / 9;
    border-radius: var(--radius-xl);
    overflow: hidden;
    box-shadow: var(--shadow-xl);
  }

  .project-image-placeholder {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-tertiary);
  }

  .project-icon {
    opacity: 0.3;
  }

  .project-content {
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
    margin-bottom: var(--space-12);
  }

  /* Prose styles for markdown content */
  .prose :global(h2) {
    font-size: var(--text-3xl);
    margin-top: var(--space-10);
    margin-bottom: var(--space-4);
    color: var(--text-primary);
  }

  .prose :global(h3) {
    font-size: var(--text-2xl);
    margin-top: var(--space-8);
    margin-bottom: var(--space-3);
    color: var(--text-primary);
  }

  .prose :global(p) {
    font-size: var(--text-lg);
    margin-bottom: var(--space-4);
    line-height: var(--leading-relaxed);
    color: var(--text-secondary);
  }

  .prose :global(ul),
  .prose :global(ol) {
    margin-bottom: var(--space-4);
    padding-left: var(--space-6);
  }

  .prose :global(li) {
    margin-bottom: var(--space-2);
    color: var(--text-secondary);
  }

  .prose :global(strong) {
    color: var(--text-primary);
    font-weight: var(--font-semibold);
  }

  .prose :global(a) {
    color: var(--color-primary);
    text-decoration: underline;
  }

  .prose :global(a:hover) {
    color: var(--color-primary-dark);
  }

  .prose :global(code) {
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    background: var(--bg-secondary);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
  }

  .prose :global(pre) {
    background: var(--bg-dark);
    color: var(--text-light);
    padding: var(--space-4);
    border-radius: var(--radius-lg);
    overflow-x: auto;
    margin-bottom: var(--space-4);
  }

  .prose :global(pre code) {
    background: transparent;
    padding: 0;
  }

  .project-footer {
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
    padding-top: var(--space-8);
    border-top: 1px solid var(--bg-tertiary);
  }

  .project-footer :global(.button) {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
  }

  /* GitHub project styles */
  .github-content {
    text-align: center;
    padding: var(--space-8);
    background: var(--bg-secondary);
    border-radius: var(--radius-xl);
  }

  .github-info {
    display: flex;
    justify-content: center;
    gap: var(--space-6);
    margin-bottom: var(--space-6);
  }

  .github-stat {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-lg);
    color: var(--text-secondary);
  }

  .github-stat svg {
    color: var(--color-accent);
  }

  .language-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
  }

  .github-description {
    font-size: var(--text-lg);
    color: var(--text-secondary);
    margin-bottom: var(--space-6);
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
  }

  .github-content :global(.button) {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
  }
</style>
