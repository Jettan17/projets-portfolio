---
import BaseLayout from '../layouts/BaseLayout.astro';
import LogoSplash from '../components/LogoSplash.astro';
import IntroSplash from '../components/IntroSplash.astro';
import WhatIDo from '../components/WhatIDo.astro';
import MyApproach from '../components/MyApproach.astro';
import Hero from '../components/Hero.astro';
import ScrollTransition from '../components/ScrollTransition.astro';
import ProjectGrid from '../components/ProjectGrid.astro';
import SkillBadge from '../components/SkillBadge.astro';
import Button from '../components/Button.astro';
import { getCollection } from 'astro:content';
import { getGitHubProjectsWithStatus, mergeProjects, getFeaturedProjects, sortByDate } from '../utils/projects';
import personal from '../data/personal.json';

// Fetch both markdown and GitHub projets
const markdownProjets = await getCollection('projets');
const githubResult = await getGitHubProjectsWithStatus();

// Merge all projets
const allProjets = mergeProjects(
  markdownProjets.map(p => ({
    slug: p.slug,
    data: { ...p.data, source: 'markdown' as const },
  })),
  githubResult.projects
);

// Get featured projets, or fall back to most recent if none are featured
const featured = getFeaturedProjects(allProjets);
const sortedProjets = featured.length > 0
  ? sortByDate(featured).slice(0, 3)
  : sortByDate(allProjets).slice(0, 3);

// Track if we had any GitHub fetch errors
const hasGitHubErrors = githubResult.hasErrors;

const skillVariants = ['primary', 'secondary', 'accent', 'default'] as const;
---

<BaseLayout title="Home" description="Personal portfolio showcasing creative web development projects">
  <!-- Scrolljack sections (GSAP controlled) -->
  <div class="scrolljack-container">
    <LogoSplash />
    <IntroSplash />
    <WhatIDo />
    <MyApproach />
    <Hero />
    <ScrollTransition />
  </div>

  <!-- Normal scrolling content -->
  <div class="normal-content">
    <!-- Featured Projets Section -->
    <section class="section featured-projets">
      <div class="container">
        <div class="section-header">
          <h2 class="section-title">
            Featured <span class="gradient-text">Projets</span>
          </h2>
          <p class="section-description">
            A selection of my recent work. Each projet represents a unique challenge and creative solution.
          </p>
        </div>

        {hasGitHubErrors && sortedProjets.length === 0 && (
          <div class="error-banner">
            <p>Unable to load projets from GitHub. Please try refreshing the page.</p>
          </div>
        )}

        <ProjectGrid projects={sortedProjets} />

        <div class="section-cta">
          <Button href="/projets" variant="outline">
            View All Projets
          </Button>
        </div>
      </div>
    </section>

    <!-- Skills Section -->
    <section class="section skills-section">
      <div class="container">
        <div class="section-header">
          <h2 class="section-title">
            Skills & <span class="gradient-text-secondary">Technologies</span>
          </h2>
          <p class="section-description">
            The tools and technologies I use to bring ideas to life.
          </p>
        </div>

        <div class="skills-grid">
          {personal.skills.map((skill: string, index: number) => (
            <SkillBadge
              skill={skill}
              variant={skillVariants[index % skillVariants.length]}
            />
          ))}
        </div>
      </div>
    </section>

    <!-- CTA Section -->
    <section class="section cta-section">
      <div class="container">
        <div class="cta-content">
          <h2 class="cta-title">Let's Work Together</h2>
          <p class="cta-description">
            Have a project in mind? I'd love to hear about it. Let's create something amazing together.
          </p>
          <div class="cta-actions">
            <Button href={personal.social.github} variant="primary" size="lg" external>
              View My GitHub
            </Button>
            <Button href="/about" variant="ghost" size="lg">
              Learn More About Me
            </Button>
          </div>
        </div>
      </div>
    </section>
  </div>
</BaseLayout>

<!-- GSAP ScrollTrigger initialization -->
<script>
  import { initScrollJack } from '../scripts/scrolljack';

  // Initialize on page load
  document.addEventListener('astro:page-load', () => {
    initScrollJack();
  });

  // Also init immediately for first load
  initScrollJack();
</script>

<style>
  /* Scrolljack container - sections flow naturally, GSAP handles pinning */
  .scrolljack-container {
    /* No special styling needed - GSAP handles everything */
  }

  .scrolljack-container :global(.panel) {
    /* Panels need overflow hidden to prevent bleed */
    overflow: hidden;
  }

  /* Normal content - standard scroll */
  .normal-content {
    position: relative;
    z-index: 1;
  }

  .section-header {
    text-align: center;
    margin-bottom: var(--space-12);
  }

  .section-title {
    font-size: var(--text-4xl);
    margin-bottom: var(--space-4);
  }

  .section-description {
    font-size: var(--text-lg);
    color: var(--text-secondary);
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  .section-cta {
    display: flex;
    justify-content: center;
    margin-top: var(--space-12);
  }

  /* Featured Projets */
  .featured-projets {
    background: var(--bg-secondary);
  }

  /* Skills Section */
  .skills-section {
    background: var(--bg-primary);
  }

  .skills-grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: var(--space-3);
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
  }

  .skills-grid :global(.skill-badge) {
    font-size: var(--text-base);
    padding: var(--space-2) var(--space-4);
  }

  /* CTA Section */
  .cta-section {
    background: var(--bg-dark);
    color: var(--text-light);
    position: relative;
    overflow: hidden;
  }

  .cta-section::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 400px;
    height: 400px;
    background: radial-gradient(circle, rgba(255, 107, 107, 0.2) 0%, transparent 70%);
    pointer-events: none;
  }

  .cta-section::after {
    content: '';
    position: absolute;
    bottom: -30%;
    left: -10%;
    width: 300px;
    height: 300px;
    background: radial-gradient(circle, rgba(78, 205, 196, 0.15) 0%, transparent 70%);
    pointer-events: none;
  }

  .cta-content {
    position: relative;
    z-index: 1;
    text-align: center;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  .cta-title {
    font-size: var(--text-4xl);
    margin-bottom: var(--space-4);
    color: var(--text-light);
  }

  .cta-description {
    font-size: var(--text-lg);
    color: var(--text-tertiary);
    margin-bottom: var(--space-8);
  }

  .cta-actions {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: var(--space-4);
  }

  .cta-actions :global(.button--ghost) {
    color: var(--text-light);
  }

  .cta-actions :global(.button--ghost:hover) {
    background: rgba(255, 255, 255, 0.1);
  }

  .error-banner {
    background: rgba(255, 107, 107, 0.1);
    border: 1px solid var(--color-primary);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    margin-bottom: var(--space-8);
    text-align: center;
  }

  .error-banner p {
    color: var(--color-primary);
    margin: 0;
  }
</style>
